name: RDP Setup with Chrome Remote Desktop

on:
  push:
    branches:
      - main

jobs:
  setup-rdp-chrome-remote-desktop:
    runs-on: windows-latest

    steps:
      - name: Set up RDP on Windows
        run: |
          # Mở cổng RDP (3389) trong tường lửa
          New-NetFirewallRule -DisplayName "Open RDP Port" -Enabled True -Protocol TCP -Action Allow -Direction Inbound -LocalPort 3389
          
          # Cài đặt RDP nếu chưa cài
          $rdp = Get-WindowsFeature -Name Remote-Desktop-Services
          if (-not $rdp.Installed) {
            Install-WindowsFeature -Name Remote-Desktop-Services
          }
          
          # Khởi động dịch vụ Remote Desktop
          Start-Service -Name TermService
          
          # Tạo tài khoản người dùng cho RDP
          $userName = "rdpuser"
          $password = "P@ssw0rd123!"  # Đảm bảo mật khẩu phức tạp đủ
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $userName -Password $securePassword -FullName "RDP User" -Description "User for RDP Access"
          Add-LocalGroupMember -Group "Administrators" -Member $userName

      - name: Download and Install Chrome Remote Desktop Host
        run: |
          # Tải xuống và cài đặt Chrome Remote Desktop Host
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chromeremotedesktophost.msi"
          Start-Process -FilePath "chromeremotedesktophost.msi" -ArgumentList "/quiet" -Wait

      - name: Start Chrome Remote Desktop and Set PIN
        env:
          COMPUTERNAME: ${{ runner.os }}
          REMOTE_CODE: "4/0ASVgi3IniSalyI11wZYl4lI6OnLc9M_LzndQGwRP4sghf5dxE3gWIjdUkLKKQFTrd51-vA"  # Thay bằng mã OAuth của bạn
        run: |
          # Khởi động Chrome Remote Desktop Host
          Start-Process -FilePath "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" -ArgumentList "--code=$env:REMOTE_CODE --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=$Env:COMPUTERNAME"
          
          # Đảm bảo nhập mã PIN tự động
          Start-Sleep -Seconds 5  # Đợi 5 giây để Chrome Remote Desktop yêu cầu nhập mã PIN
          
          # Gửi mã PIN '123456'
          Add-Type -TypeDefinition @"
            using System;
            using System.Runtime.InteropServices;
            public class Keyboard {
                [DllImport("user32.dll")]
                public static extern void keybd_event(byte bVk, byte bScan, uint dwFlags, uint dwExtraInfo);
            }
          "@
          
          # Gửi mã PIN '123456'
          [Keyboard]::keybd_event(0x31, 0, 0, 0)  # 1
          [Keyboard]::keybd_event(0x31, 0, 2, 0)  # 1
          [Keyboard]::keybd_event(0x32, 0, 0, 0)  # 2
          [Keyboard]::keybd_event(0x32, 0, 2, 0)  # 2
          [Keyboard]::keybd_event(0x33, 0, 0, 0)  # 3
          [Keyboard]::keybd_event(0x33, 0, 2, 0)  # 3
          [Keyboard]::keybd_event(0x34, 0, 0, 0)  # 4
          [Keyboard]::keybd_event(0x34, 0, 2, 0)  # 4
          [Keyboard]::keybd_event(0x35, 0, 0, 0)  # 5
          [Keyboard]::keybd_event(0x35, 0, 2, 0)  # 5
          [Keyboard]::keybd_event(0x36, 0, 0, 0)  # 6
          [Keyboard]::keybd_event(0x36, 0, 2, 0)  # 6
          
          # Nhấn Enter để xác nhận
          [Keyboard]::keybd_event(0x0D, 0, 0, 0)  # Enter
          [Keyboard]::keybd_event(0x0D, 0, 2, 0)  # Enter

      - name: Wait for 6 hours
        run: |
          # Giữ kết nối RDP trong 6 giờ
          Start-Sleep -Seconds 21600  # 6 giờ = 21600 giây

      - name: Clean up
        run: |
          # Dừng Chrome Remote Desktop và RDP nếu cần
          Stop-Process -Name "remoting_start_host" -Force
          Stop-Service -Name TermService
