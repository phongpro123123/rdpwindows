name: RDP Setup with Chrome Remote Desktop

on:
  push:
    branches:
      - main

jobs:
  setup-rdp-chrome-remote-desktop:
    runs-on: windows-latest

    steps:
      - name: Set up RDP on Windows
        run: |
          # Mở cổng RDP (3389) trong tường lửa
          New-NetFirewallRule -DisplayName "Open RDP Port" -Enabled True -Protocol TCP -Action Allow -Direction Inbound -LocalPort 3389
          
          # Cài đặt RDP nếu chưa cài
          $rdp = Get-WindowsFeature -Name Remote-Desktop-Services
          if (-not $rdp.Installed) {
            Install-WindowsFeature -Name Remote-Desktop-Services
          }
          
          # Khởi động dịch vụ Remote Desktop
          Start-Service -Name TermService
          
          # Tạo tài khoản người dùng cho RDP
          $userName = "rdpuser"
          $password = "P@ssw0rd123!"  # Đảm bảo mật khẩu phức tạp đủ
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $userName -Password $securePassword -FullName "RDP User" -Description "User for RDP Access"
          Add-LocalGroupMember -Group "Administrators" -Member $userName

      - name: Download and Install Chrome Remote Desktop Host
        run: |
          # Tải xuống và cài đặt Chrome Remote Desktop Host
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chromeremotedesktophost.msi"
          Start-Process -FilePath "chromeremotedesktophost.msi" -ArgumentList "/quiet" -Wait

      - name: Start Chrome Remote Desktop (Interactive)
        env:
          COMPUTERNAME: ${{ runner.os }}
          REMOTE_CODE: "4/0ASVgi3LmwIyBSqk5Cn7Dp54nqwJIFkXgEaVSI1rhgB8kFx7vH4G3jd0Bw5NS6qUvyCLQqg"  # Thay bằng mã OAuth của bạn
        run: |
          # Khởi động Chrome Remote Desktop Host
          Start-Process -FilePath "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" -ArgumentList "--code=$env:REMOTE_CODE --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=$Env:COMPUTERNAME" -NoNewWindow
          
          # Dừng quá trình workflow tại đây và chờ mã PIN
          Write-Host "Vui lòng nhập mã PIN khi yêu cầu xuất hiện và nhấn Enter để tiếp tục."
          
          # Ghi chú: Mã PIN cần được nhập vào cửa sổ console sau khi workflow tạm dừng tại bước này.
          # Workflow sẽ tiếp tục sau khi có sự tương tác của người dùng bằng cách nhấn Enter.
          
          # Chờ một dòng đầu vào (nhấn Enter) từ người dùng.
          $null = Read-Host "Nhập bất kỳ điều gì và nhấn Enter để tiếp tục sau khi đã cài đặt xong Chrome Remote Desktop"

      - name: Wait for 6 hours
        run: |
          # Sau khi nhập mã PIN và nhấn Enter, giữ kết nối RDP trong 6 giờ
          Write-Host "Đang giữ kết nối RDP trong 6 giờ..."
          Start-Sleep -Seconds 21600  # 6 giờ = 21600 giây

      - name: Clean up
        run: |
          # Dừng Chrome Remote Desktop và RDP nếu cần
          Stop-Process -Name "remoting_start_host" -Force
          Stop-Service -Name TermService
